name: Release
run-name: Release ${{ github.ref_name }}
permissions:
    contents: read
    checks: write
on:
    release:
        types: [published]
jobs:
    build-test-publish:
        runs-on: ubuntu-latest
        env:
            CONFIGURATION: Release
            TARGET_FRAMEWORK: net10.0
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v6

            - name: Get Version from Release Tag
              id: get_version
              run: |
                  VERSION=${GITHUB_REF_NAME#v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Building release version: $VERSION"

            - name: Install .NET
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: 10.0.x

            - name: Restore
              run: dotnet restore

            - name: Build
              id: build
              run: dotnet build --no-restore --configuration ${{ env.CONFIGURATION }} /p:Version=${{ steps.get_version.outputs.version }}

            - name: Test Wizdle.Unit.Tests
              if: steps.build.outcome == 'success'
              run: dotnet test Wizdle.Unit.Tests/Wizdle.Unit.Tests.csproj --no-build --configuration ${{ env.CONFIGURATION }} --logger "trx;LogFileName=Wizdle.Unit.Tests.trx"

            - name: Test Wizdle.Integration.Tests
              if: steps.build.outcome == 'success'
              run: dotnet test Wizdle.Integration.Tests/Wizdle.Integration.Tests.csproj --no-build --configuration ${{ env.CONFIGURATION }} --logger "trx;LogFileName=Wizdle.Integration.Tests.trx"

            - name: Build Docker for Wizdle.Api
              id: build-api
              if: steps.build.outcome == 'success'
              run: make build-api

            - name: Test Wizdle.Api.Functional.Tests
              if: steps.build-api.outcome == 'success'
              run: dotnet test Wizdle.Api.Functional.Tests/Wizdle.Api.Functional.Tests.csproj --no-build --configuration ${{ env.CONFIGURATION }} --logger "trx;LogFileName=Wizdle.Api.Functional.Tests.trx"

            - name: Install Playwright
              id: install-playwright
              if: steps.build.outcome == 'success'
              run: pwsh Wizdle.Web.Functional.Tests/bin/${{ env.CONFIGURATION }}/${{ env.TARGET_FRAMEWORK }}/playwright.ps1 install --with-deps --no-shell

            - name: Build Docker for Wizdle.Web
              id: build-web
              if: steps.install-playwright.outcome == 'success'
              run: make build-web

            - name: Test Wizdle.Web.Functional.Tests
              if: steps.build-web.outcome == 'success'
              run: dotnet test Wizdle.Web.Functional.Tests/Wizdle.Web.Functional.Tests.csproj --no-build --configuration ${{ env.CONFIGURATION }} --logger "trx;LogFileName=Wizdle.Web.Functional.Tests.trx"

            - name: Upload Artifacts for Wizdle.Web.Functional.Tests
              uses: actions/upload-artifact@v6
              if: (!cancelled())
              with:
                  name: Wizdle.Web.Functional.Tests
                  retention-days: 20
                  if-no-files-found: error
                  path: |
                      Wizdle.Web.Functional.Tests/bin/**/reports/
                      Wizdle.Web.Functional.Tests/bin/**/screenshots/
                      Wizdle.Web.Functional.Tests/bin/**/playwright-traces/

            - name: Publish All Test Results
              uses: EnricoMi/publish-unit-test-result-action@v2
              if: (!cancelled())
              with:
                  files: "**/*.trx"
                  action_fail_on_inconclusive: true

            - name: NuGet Push to NuGet.org
              if: success()
              run: dotnet nuget push **.nupkg --api-key ${{secrets.NUGET}} --source "https://api.nuget.org/v3/index.json" --skip-duplicate

            - name: NuGet Push to GitHub Packages
              if: success()
              run: dotnet nuget push **.nupkg --api-key ${{secrets.GITHUB}} --source "https://nuget.pkg.github.com/lyndychivs/index.json" --skip-duplicate

            - name: Upload NuGet Package to Release
              if: success()
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      **/*.nupkg
                      **/*.snupkg

    build-wpf-installer:
        runs-on: windows-latest
        env:
            CONFIGURATION: Release
            TARGET_FRAMEWORK: net10.0-windows
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v6

            - name: Get Version from Release Tag
              id: get_version
              shell: pwsh
              run: |
                  $VERSION = $env:GITHUB_REF_NAME -replace '^v', ''
                  echo "version=$VERSION" >> $env:GITHUB_OUTPUT
                  echo "Building release version: $VERSION"

            - name: Install .NET
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: 10.0.x

            - name: Restore
              run: dotnet restore

            - name: Build Wizdle.Wpf
              run: dotnet build Wizdle.Wpf/Wizdle.Wpf.csproj --no-restore --configuration ${{ env.CONFIGURATION }} /p:Version=${{ steps.get_version.outputs.version }}

            - name: Publish Wizdle.Wpf for win-x64
              run: dotnet publish Wizdle.Wpf/Wizdle.Wpf.csproj --no-build --configuration ${{ env.CONFIGURATION }} --runtime win-x64 --self-contained true /p:PublishSingleFile=true /p:Version=${{ steps.get_version.outputs.version }}

            - name: Publish Wizdle.Wpf for win-x86
              run: dotnet publish Wizdle.Wpf/Wizdle.Wpf.csproj --no-build --configuration ${{ env.CONFIGURATION }} --runtime win-x86 --self-contained true /p:PublishSingleFile=true /p:Version=${{ steps.get_version.outputs.version }}

            - name: Update ISS version for x64
              shell: pwsh
              run: |
                  $content = Get-Content 'Installer/Wizdle.Windows.x64.iss' -Raw
                  $content = $content -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ steps.get_version.outputs.version }}`""
                  Set-Content 'Installer/Wizdle.Windows.x64.iss' -Value $content

            - name: Update ISS version for x86
              shell: pwsh
              run: |
                  $content = Get-Content 'Installer/Wizdle.Windows.x86.iss' -Raw
                  $content = $content -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ steps.get_version.outputs.version }}`""
                  Set-Content 'Installer/Wizdle.Windows.x86.iss' -Value $content

            - name: Install Inno Setup
              shell: pwsh
              run: |
                  choco install innosetup -y

            - name: Compile x64 Installer
              shell: pwsh
              run: |
                  & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "Installer\Wizdle.Windows.x64.iss"

            - name: Compile x86 Installer
              shell: pwsh
              run: |
                  & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "Installer\Wizdle.Windows.x86.iss"

            - name: Upload Installers to Release
              if: success()
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      Installer/Output/*.exe
